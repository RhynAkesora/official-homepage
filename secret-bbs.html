<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メンバー専用掲示板</title>
    
    <!-- 1. 検索エンジン除け（必須） -->
    <meta name="robots" content="noindex, nofollow">

    <!-- 2. Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3. React & Firebase ライブラリの読み込み -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { opacity: 0; transition: opacity 0.3s; }
        body.loaded { opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">

    <!-- ▼▼▼ 既存のHTMLに組み込む場合は、ここから下をコピーしてください ▼▼▼ -->
    
    <!-- アプリケーションの描画領域 -->
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'firebase/firestore';
        import { getAuth, signInAnonymously } from 'firebase/auth';

        // ▼▼▼ Firebase設定（ご自身のものに書き換えてください） ▼▼▼
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const COLLECTION_NAME = 'salon_posts';

        // アイコン
        const IconSend = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
        const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        function App() {
            // 名前はローカルストレージ（ブラウザ）から読み込む
            const [name, setName] = useState(localStorage.getItem('salon_user_name') || '');
            const [posts, setPosts] = useState([]);
            const [newPost, setNewPost] = useState('');
            const [errorMsg, setErrorMsg] = useState('');

            // 初期化：匿名認証 & データ監視
            useEffect(() => {
                document.body.classList.add('loaded');
                
                // 1. 自動的に匿名ログイン（DBの読み書き権限のため）
                signInAnonymously(auth).catch((err) => {
                    console.error("Auth Error:", err);
                    setErrorMsg("接続エラーが発生しました。");
                });

                // 2. リアルタイムでデータを取得
                const q = query(collection(db, COLLECTION_NAME), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setPosts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (err) => {
                    console.error(err);
                    setErrorMsg("データの読み込みに失敗しました。");
                });

                return () => unsubscribe();
            }, []);

            // 投稿処理
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!newPost.trim() || !name.trim()) return;

                // 名前をブラウザに記憶させる
                localStorage.setItem('salon_user_name', name);

                try {
                    await addDoc(collection(db, COLLECTION_NAME), {
                        text: newPost,
                        author: name,
                        createdAt: serverTimestamp(),
                        uid: auth.currentUser ? auth.currentUser.uid : 'anonymous'
                    });
                    setNewPost(''); // 入力欄をクリア
                } catch (err) {
                    console.error(err);
                    setErrorMsg('投稿できませんでした。');
                }
            };

            const formatDate = (ts) => {
                if (!ts) return '...';
                const d = ts.toDate();
                return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            };

            return (
                <div className="max-w-3xl mx-auto px-4 py-8 pb-20">
                    <header className="mb-8 border-b pb-4 border-gray-300">
                        <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Salon Board</h1>
                        <p className="text-xs text-gray-500 mt-1">メンバー専用・検索除け済み</p>
                    </header>

                    {/* 投稿フォーム */}
                    <div className="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mb-8">
                        <form onSubmit={handleSubmit} className="space-y-3">
                            {/* 名前入力 */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wide block mb-1">お名前</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-2.5 text-gray-400"><IconUser /></div>
                                    <input 
                                        type="text" 
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:ring-2 focus:ring-slate-500 outline-none transition text-sm"
                                        placeholder="表示名を入力"
                                    />
                                </div>
                            </div>

                            {/* 本文入力 */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wide block mb-1">メッセージ</label>
                                <textarea 
                                    value={newPost} 
                                    onChange={(e) => setNewPost(e.target.value)}
                                    className="w-full h-20 p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:ring-2 focus:ring-slate-500 outline-none resize-none text-sm leading-relaxed"
                                    placeholder="近況や実践の報告など..."
                                />
                            </div>

                            {errorMsg && <p className="text-red-500 text-xs">{errorMsg}</p>}

                            <div className="flex justify-end">
                                <button 
                                    type="submit" 
                                    disabled={!newPost.trim() || !name.trim()}
                                    className="bg-slate-800 text-white px-5 py-2 rounded text-sm font-bold hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2"
                                >
                                    <IconSend /> 投稿
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* 投稿一覧 */}
                    <div className="space-y-4">
                        {posts.map((post) => (
                            <div key={post.id} className="bg-white p-5 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition duration-200">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="font-bold text-slate-700 text-sm">{post.author}</span>
                                    <span className="text-xs text-gray-400 font-mono">{formatDate(post.createdAt)}</span>
                                </div>
                                <div className="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">{post.text}</div>
                            </div>
                        ))}
                        
                        {posts.length === 0 && (
                            <p className="text-center text-gray-400 text-sm py-10">まだ投稿はありません。</p>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
